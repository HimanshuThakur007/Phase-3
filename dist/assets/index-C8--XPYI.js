import{c as useParams,b as useLocation,p as useNavigate,q as useSelector,v as hooks,j as jsxRuntimeExports,r as renderField,w as InputSelect,W as Wrapper,C as CenteredLoader}from"./index-lKAf_eBp.js";import{a as reactExports,u as useForm,F as FormProvider,R as React}from"./react-hook-form-Bavd7xdc.js";import{u as useApiHandler}from"./customapiHandler-9LOoEkAu.js";const dynamicController=()=>{const{id:id}=useParams(),location=useLocation(),navigate=useNavigate(),{loadTableData:loadTableData,loadDropdownOptions:loadDropdownOptions,submitHandler:submitHandler}=useApiHandler(),{RepID:RepID,Caption:Caption}=(null==location?void 0:location.state)||{},{decryptedData:decryptedData}=useSelector(state=>state.authData),{CompCode:CompCode,FinYear:FinYear,CompnayName:CompnayName,ID:ID}=decryptedData||{};console.log("sessionData from DynamicRpt",decryptedData);const[dynamicData,setDynamicData]=reactExports.useState({formData:[],loading:!1}),form=useForm({defaultValues:{},mode:"onChange"}),updateState=reactExports.useCallback(newState=>setDynamicData(prev=>({...prev,...newState})),[]);reactExports.useEffect(()=>{console.log("uuuuu=>",`Report/GetRepOptions?RepID=${RepID}&CompCode=${CompCode}&FY=${FinYear}&UserID=${ID||0}`);if(RepID&&CompCode){loadTableData({url:`Report/GetRepOptions?RepID=${RepID}&CompCode=${CompCode}&FY=${FinYear}&UserID=${ID||0}`,setState:setDynamicData,setLoading:value=>updateState({loading:value}),key:"formData"});console.log("Reports-sata",dynamicData)}},[loadTableData,updateState,RepID,CompCode]);const{reset:reset,watch:watch,setValue:setValue}=form,[selectedMasterTypes,setSelectedMasterTypes]=reactExports.useState({}),[selectOptions,setSelectOptions]=reactExports.useState({}),[selectLoading,setSelectLoading]=reactExports.useState({}),allValues=watch();reactExports.useEffect(()=>{reset();setSelectedMasterTypes({});setSelectOptions({});setSelectLoading({})},[id,reset]);const fetchSelectOptions=reactExports.useCallback(async(fieldIndex,masterType,recType,OptVchType,OptShowAllFiler,isExtra=!1)=>{console.log(isExtra);updateState({loading:!0});const url=`Report/GetBusyMaster?CompCode=${CompCode}&FY=${FinYear}&MasterType=${masterType}&RecType=${recType||0}&VchType=${OptVchType}&ShowAllFilter=${OptShowAllFiler}&UserID=${ID||0}`;console.log("url-of-GetBusyMaster",url);try{setSelectLoading(prev=>({...prev,[fieldIndex]:!0}));await loadDropdownOptions({url:url,setState:options=>setSelectOptions(prev=>({...prev,[fieldIndex]:options})),setLoading:loading=>setSelectLoading(prev=>({...prev,[fieldIndex]:loading})),valueKey:"Code",labelKey:"Name",additionalKeys:["NameAlias"]})}catch(error){console.error("Failed to fetch select options:",error)}finally{updateState({loading:!1})}},[loadDropdownOptions,CompCode,FinYear,updateState]);reactExports.useEffect(()=>{if(dynamicData.formData.length>0){const defaultValues={},newSelectedMasterTypes={},newSelectOptions={};dynamicData.formData.forEach((field,index)=>{var _a,_b;const key=`field-${index}`,{OptDataType:OptDataType,OptMasterValue:OptMasterValue,OptRangeType:OptRangeType,OptMasterType:OptMasterType,OptRecType:OptRecType,OptMasterCode:OptMasterCode,OptVchType:OptVchType,OptShowAllFiler:OptShowAllFiler}=field;if("Date"===OptDataType){const parsedDate=hooks(OptMasterValue,["DD/MMM/YYYY","DD-MMM-YYYY"]);defaultValues[key]=parsedDate.isValid()?parsedDate.toISOString():""}else if("Yes/No"===OptDataType)defaultValues[key]="Yes"===OptMasterValue?1:0;else if("Select"===OptDataType&&1===OptRangeType){const masterValue=null!=OptMasterCode?Number(OptMasterCode):"";defaultValues[key]=masterValue;newSelectedMasterTypes[index]=masterValue;field.OptRange&&(newSelectOptions[index]=field.OptRange.map(opt=>({value:opt.MasterType,label:opt.MasterValue,recType:opt.RecType,OptCaption:opt.MasterCaption})));if(masterValue&&OptMasterType){const recType=null==(_b=null==(_a=field.OptRange)?void 0:_a.find(opt=>opt.MasterType===masterValue))?void 0:_b.RecType;recType&&fetchSelectOptions(index+.5,masterValue,recType,OptVchType||0,OptShowAllFiler||0,!0)}null!=OptMasterCode&&(defaultValues[`${key}-extra`]=OptMasterCode.toString())}else if("Select"===OptDataType){defaultValues[key]=null!=OptMasterCode?Number(OptMasterCode):"";OptMasterType&&fetchSelectOptions(index,OptMasterType,OptRecType||0,OptVchType||0,OptShowAllFiler||0,!1)}else defaultValues[key]=OptMasterValue||""});form.reset(defaultValues);setSelectedMasterTypes(newSelectedMasterTypes);setSelectOptions(prev=>({...prev,...newSelectOptions}))}},[dynamicData.formData,form,fetchSelectOptions]);const getDynamicOptions=field=>{var _a;return"Select"!==field.OptDataType||1!==field.OptRangeType?[]:(null==(_a=field.OptRange)?void 0:_a.map(opt=>({value:opt.MasterType,label:opt.MasterValue,recType:opt.RecType,OptCaption:opt.MasterCaption})))||[]},handleSelectChange=(fieldIndex,selectedOption)=>{const value=(null==selectedOption?void 0:selectedOption.value)??"";setValue(`field-${fieldIndex}`,value);setSelectedMasterTypes(prev=>({...prev,[fieldIndex]:value}));setSelectOptions(prev=>({...prev,[fieldIndex+.5]:[]}));setValue(`field-${fieldIndex}-extra`,"");if(value&&0!==value&&(null==selectedOption?void 0:selectedOption.recType)){const field=dynamicData.formData[fieldIndex];fetchSelectOptions(fieldIndex+.5,value,selectedOption.recType,field.OptVchType||0,field.OptShowAllFiler||0,!0)}},handleRegularSelectChange=(fieldIndex,selectedOption)=>{const value=(null==selectedOption?void 0:selectedOption.value)??"";setValue(`field-${fieldIndex}`,value)},handleExtraSelectChange=(fieldIndex,selectedOption)=>{const value=(null==selectedOption?void 0:selectedOption.value)??"";setValue(`field-${fieldIndex}-extra`,value)},getComponentType=dataType=>{switch(dataType){case"Select":return"InputSelect";case"Date":return"InputDate";case"Yes/No":return"InputToggle";default:return"InputField"}},renderFieldComponent=(field,index)=>{var _a;const key=`field-${index}`,options=1===field.OptRangeType?getDynamicOptions(field):selectOptions[index]||[],isLoading=selectLoading[index]||!1,fieldSchema={component:getComponentType(field.OptDataType),props:{name:key,label:field.OptCaption,required:1===field.OptRequired,disabled:!1,isClearable:!0}},selectedValue=selectedMasterTypes[index],selectedOption=options.find(opt=>opt.value===selectedValue),mainField=jsxRuntimeExports.jsx("div",{className:"col-md-12 mb-0",children:"Select"===field.OptDataType?jsxRuntimeExports.jsx(InputSelect,{name:key,label:field.OptCaption,options:options,required:1===field.OptRequired,isDisabled:!1,onChange:1===field.OptRangeType?selected=>handleSelectChange(index,selected):selected=>handleRegularSelectChange(index,selected),isClearable:!0,isLoading:isLoading,value:options.find(opt=>opt.value===allValues[key])||null}):renderField({field:fieldSchema,form:form,options:options,key:key})},key),extraSelect=1===field.OptRangeType&&selectedValue&&0!==selectedValue&&selectedOption?jsxRuntimeExports.jsx("div",{className:"col-md-12 mb-0",children:jsxRuntimeExports.jsx(InputSelect,{name:`${key}-extra`,label:selectedOption.OptCaption||"Additional Select",options:selectOptions[index+.5]||[],required:1===field.OptRequired,isDisabled:!1,isClearable:!0,isLoading:selectLoading[index+.5]||!1,value:(null==(_a=selectOptions[index+.5])?void 0:_a.find(opt=>opt.value===allValues[`${key}-extra`]))||null,onChange:selected=>handleExtraSelectChange(index,selected)})},`${key}-extra`):null;return[mainField,extraSelect]},formatDate=date=>{if(!date)return"";const parsedDate=hooks(date);return parsedDate.isValid()?parsedDate.format("DD-MMM-YYYY"):""},handleSubmit=async data=>{const formattedData=dynamicData.formData.map((field,index)=>{const key=`field-${index}`;let optMasterCode=0,optMasterValue="",optMasterType=field.OptMasterType;if("Select"===field.OptDataType)if(1===field.OptRangeType){const extraKey=`${key}-extra`,selectedValue=data[extraKey]||"",options=selectOptions[index+.5]||[],selectedOption=options.find(opt=>opt.value===selectedValue);optMasterCode=selectedValue?Number(selectedValue):field.OptMasterCode||0;optMasterValue=(null==selectedOption?void 0:selectedOption.label)||field.OptMasterValue||"";const mainSelectedValue=data[key]||"";optMasterType=mainSelectedValue?Number(mainSelectedValue):field.OptMasterType||0}else{const selectedValue=data[key]||"",options=selectOptions[index]||[],selectedOption=options.find(opt=>opt.value===selectedValue);optMasterCode=selectedValue?Number(selectedValue):field.OptMasterCode||0;optMasterValue=(null==selectedOption?void 0:selectedOption.label)||field.OptMasterValue||""}else if("Date"===field.OptDataType)optMasterValue=formatDate(data[key]);else if("Yes/No"===field.OptDataType){optMasterValue=data[key]?"Yes":"No";optMasterCode=data[key]?1:0}else"Input"===field.OptDataType&&(optMasterValue=data[key]||"");return{OptRangeType:field.OptRangeType,OptRange:field.OptRange||[],OptCaption:field.OptCaption,OptDataType:field.OptDataType,OptVchType:field.OptVchType,OptMasterType:optMasterType,OptRecType:field.OptRecType,OptShowAllFiler:field.OptShowAllFiler,OptMasterCode:optMasterCode,OptMasterValue:optMasterValue,OptShowCaptionIndex:field.OptShowCaptionIndex,OptRequired:field.OptRequired,OptFilterType:field.OptFilterType}});try{await submitHandler({url:`Report/GetReportData?RepID=${RepID}&CompCode=${CompCode}&FY=${FinYear}`,method:"POST",data:formattedData,setLoading:value=>{updateState({loading:value})},onSuccess:data2=>{form.reset();const navigateData={...data2,formattedData:JSON.stringify(formattedData,null,2),RepID:RepID,Caption:Caption};navigate(`/RepList/${id}`,{state:{navigateData:navigateData}})},onError:error=>{console.error("Error saving form:",error);updateState({loading:!1})}})}catch(error){console.error("Error submitting form:",error)}console.log("Form submitted:",JSON.stringify(formattedData,null,2))},handleCancel=()=>{form.reset()};return{id:id,Caption:Caption,form:form,formData:dynamicData.formData,handleSubmit:handleSubmit,handleCancel:handleCancel,renderFieldComponent:renderFieldComponent,loading:dynamicData.loading,CompnayName:CompnayName}},DynamicPage=()=>{const{Caption:Caption,form:form,formData:formData,handleSubmit:handleSubmit,renderFieldComponent:renderFieldComponent,loading:loading,CompnayName:CompnayName}=dynamicController();return jsxRuntimeExports.jsx(Wrapper,{header:Caption??"",subHeader:CompnayName,children:0!==(null==formData?void 0:formData.length)||loading?jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[loading&&jsxRuntimeExports.jsx(CenteredLoader,{}),jsxRuntimeExports.jsx(FormProvider,{...form,children:jsxRuntimeExports.jsxs("form",{onSubmit:form.handleSubmit(handleSubmit),children:[jsxRuntimeExports.jsx("div",{className:"card",children:jsxRuntimeExports.jsx("div",{className:"card-body",children:jsxRuntimeExports.jsx("div",{className:"new-employee-field",children:jsxRuntimeExports.jsx("div",{className:"row",children:null==formData?void 0:formData.map((field,index)=>jsxRuntimeExports.jsx(React.Fragment,{children:renderFieldComponent(field,index)},`field-wrapper-${index}`))})})})}),jsxRuntimeExports.jsx("div",{className:"text-end mb-1",children:jsxRuntimeExports.jsx("button",{type:"submit",className:"btn btn-primary",children:"Show Report"})})]})})]}):jsxRuntimeExports.jsx("img",{src:"/26691.png",alt:"No Data Found",style:{display:"flex",alignItems:"center",justifyContent:"center",height:"80vh",objectFit:"contain"}})})};export{DynamicPage as default};
//# sourceMappingURL=index-C8--XPYI.js.map
