import{u as useFetch,c as useParams,b as useLocation,p as useNavigate,a as useDispatch,q as useSelector,r as renderField,x as toTitleCase,j as jsxRuntimeExports,y as scheme,z as display,W as Wrapper,C as CenteredLoader,G as GridTable,A as saveScheme}from"./index-lKAf_eBp.js";import{a as reactExports,u as useForm,F as FormProvider}from"./react-hook-form-Bavd7xdc.js";const useSchemeOptions=()=>{const fetcher=useFetch(),getSchemeTypes=reactExports.useCallback(async()=>{try{const{got:got}=await fetcher("get-scheme-types","GET");return got??null}catch{return null}},[fetcher]),getSchemeGroups=reactExports.useCallback(async schemeTypeId=>{if(!schemeTypeId)return null;try{const{got:got}=await fetcher(`get-scheme-groups/${schemeTypeId}`,"GET");return got}catch{return null}},[fetcher]);return{getSchemeTypes:getSchemeTypes,getSchemeGroups:getSchemeGroups}},SimpleModal=({show:show,title:title,size:size="md",onClose:onClose,footer:footer,children:children})=>{if(!show)return null;const dlgClass="sm"===size?"modal-sm":"lg"===size?"modal-lg":"xl"===size?"modal-xl":"";return jsxRuntimeExports.jsx("div",{className:"modal fade show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"},tabIndex:-1,children:jsxRuntimeExports.jsx("div",{className:`modal-dialog ${dlgClass} modal-dialog-centered`,children:jsxRuntimeExports.jsxs("div",{className:"modal-content",children:[jsxRuntimeExports.jsxs("div",{className:"modal-header",children:[jsxRuntimeExports.jsx("h5",{className:"modal-title",children:title}),jsxRuntimeExports.jsx("button",{type:"button",className:"btn-close",onClick:onClose,"aria-label":"Close"})]}),jsxRuntimeExports.jsx("div",{className:"modal-body",children:children}),footer&&jsxRuntimeExports.jsx("div",{className:"modal-footer",children:footer})]})})})},Pase3DynamicTable=()=>{var _a,_b,_c;const{id:id}=useParams(),location=useLocation(),navigate=useNavigate(),dispatch=useDispatch(),savedSchemes=useSelector(s=>s.phase3.savedSchemes??[]),selectedDepartment=(null==(_a=location.state)?void 0:_a.department)??"",selectedBranch=(null==(_b=location.state)?void 0:_b.branchCode)??"",itemCodeFromState=(null==(_c=location.state)?void 0:_c.itemCode)??"",{data:detailData=[],loading:loading,error:error}=useSelector(state=>state.reportDetail||{data:[],loading:!1,error:null}),[tableHeight,setTableHeight]=reactExports.useState("550px"),{getSchemeTypes:getSchemeTypes,getSchemeGroups:getSchemeGroups}=useSchemeOptions(),[schemeTypes,setSchemeTypes]=reactExports.useState([]),[schemeGroups,setSchemeGroups]=reactExports.useState([]),[selectedRows,setSelectedRows]=reactExports.useState([]),selectedRowsHandler=data=>setSelectedRows(data||[]),[modalOpen,setModalOpen]=reactExports.useState(!1),[modalType,setModalType]=reactExports.useState(null),form=useForm({mode:"onBlur",defaultValues:{startDate:null,endDate:null,schemeType:null,schemeGroup:null,displayType:null}}),defaultFormValues={startDate:null,endDate:null,schemeType:null,schemeGroup:null,displayType:null},selectedSchemeType=form.watch("schemeType");reactExports.useEffect(()=>{let mounted=!0;const load=async()=>{try{const res=await getSchemeTypes();mounted&&"ok"===(null==res?void 0:res.status)&&setSchemeTypes(res.data||[])}catch(e){console.error("getSchemeTypes",e)}};load();return()=>{mounted=!1}},[getSchemeTypes]);reactExports.useEffect(()=>{if(!selectedSchemeType){setSchemeGroups([]);try{form.setValue("schemeGroup",null)}catch{}return}let mounted=!0;const load=async()=>{try{const value=selectedSchemeType.value,res=await getSchemeGroups(value);mounted&&"ok"===(null==res?void 0:res.status)&&setSchemeGroups(res.data||[])}catch(e){console.error("getSchemeGroups",e);mounted&&setSchemeGroups([])}};load();return()=>{mounted=!1}},[selectedSchemeType,getSchemeGroups,form]);const selectOptions=reactExports.useMemo(()=>({schemeType:schemeTypes,schemeGroup:schemeGroups,displayType:[{value:"Send Shelf Picture",label:"Send Shelf Picture"}]}),[schemeTypes,schemeGroups]),renderFieldWrapper=reactExports.useCallback((field,key)=>{var _a2;return renderField({field:field,form:form,options:(null==(_a2=field.props)?void 0:_a2.name)&&selectOptions[field.props.name]||[],key:key})},[form,selectOptions]),getItemCodeFromRow=reactExports.useCallback(row=>{if(!row)return;const raw=(null==row?void 0:row["Item Code"])??(null==row?void 0:row.itemCode)??(null==row?void 0:row.ItemCode)??(null==row?void 0:row.item_code)??(null==row?void 0:row.Item_Code)??(null==row?void 0:row.itemcode)??void 0;if(null==raw)return;const trimmed=String(raw).trim();return""===trimmed?void 0:trimmed},[]),getBranchCodeFromRow=reactExports.useCallback(row=>{if(selectedBranch&&""!==String(selectedBranch).trim())return String(selectedBranch).trim();if(!row)return;const raw=(null==row?void 0:row.branchCode)??(null==row?void 0:row.Branch_Code)??(null==row?void 0:row.BranchCode)??(null==row?void 0:row.branch_code)??(null==row?void 0:row.branch)??(null==row?void 0:row.Branch)??void 0;if(null==raw)return;const trimmed=String(raw).trim();return""===trimmed?void 0:trimmed},[selectedBranch]),findSavedEntryForRow=reactExports.useCallback(row=>{const itemCode=getItemCodeFromRow(row),branchCode=getBranchCodeFromRow(row);if(itemCode){if(branchCode)return savedSchemes.find(s=>String(s.itemCode??"").trim().toLowerCase()===String(itemCode).trim().toLowerCase()&&String(s.branchCode??"").trim().toLowerCase()===String(branchCode).trim().toLowerCase());const global=savedSchemes.find(s=>String(s.itemCode??"").trim().toLowerCase()===String(itemCode).trim().toLowerCase()&&(void 0===s.branchCode||null===s.branchCode));return global}try{const rowJson=JSON.stringify(row||{});return savedSchemes.find(s=>{try{return JSON.stringify(s.data)===rowJson}catch{return!1}})}catch{return}},[savedSchemes,getItemCodeFromRow,getBranchCodeFromRow]),totals=reactExports.useMemo(()=>(null==detailData?void 0:detailData.length)?detailData.reduce((acc,row)=>{const siteQty=row.total_site_qty??row.Site_Qtys??0;acc.totalSiteQty+="number"==typeof siteQty?siteQty:0;const saleQty=row.Total_Sale_Qty??row.total_sale_qty??0;acc.totalSaleQty+="number"==typeof saleQty?saleQty:0;const saleVal=row.Total_Sale_Val??row.total_sale_val??0;acc.totalSaleVal+="number"==typeof saleVal?saleVal:0;const stockVal=row.Str_Stk_Sp_Value??row.str_stk_sp_value??row.total_str_stk_sp_value??0;acc.totalStockValue+="number"==typeof stockVal?stockVal:0;return acc},{totalSiteQty:0,totalSaleQty:0,totalSaleVal:0,totalStockValue:0,totalBBStock:0,totalPoQty:0}):{totalSiteQty:0,totalSaleQty:0,totalSaleVal:0,totalStockValue:0},[detailData]),baseColumnDefs=reactExports.useMemo(()=>{if(!(null==detailData?void 0:detailData.length))return[];const first=detailData[0],keys=Object.keys(first),seen=new Set;return keys.filter(k=>{const lower=k.toLowerCase();if(lower.includes("item")&&(lower.includes("code")||lower.includes("name"))){if(seen.has("item_code")||seen.has("item_name"))return!1;lower.includes("code")&&seen.add("item_code");lower.includes("name")&&seen.add("item_name")}return!0}).map(k=>({field:k,headerName:toTitleCase(k),filter:"string"==typeof first[k]?"agTextColumnFilter":"agNumberColumnFilter",headerClass:"bg-royal-blue text-white",sortable:!0,resizable:!0}))},[detailData]),handleGridReady=api=>{"2"===id&&setTimeout(()=>{try{api.selectAll()}catch(e){}},200)},displayedColumnDefs=reactExports.useMemo(()=>{const cols=[...baseColumnDefs];if("2"===id){const hasCheckboxAlready=cols.some(c=>"__select__"===c.field||c.checkboxSelection);if(!hasCheckboxAlready){const checkboxCol={field:"__select__",headerName:"",width:48,pinned:"left",lockPosition:!0,suppressSizeToFit:!0,sortable:!1,filter:!1,resizable:!1,checkboxSelection:params=>{var _a2;try{const row=params.data,saved=findSavedEntryForRow(row);return!(null==(_a2=null==saved?void 0:saved.data)?void 0:_a2.appliedScheme)}catch(e){return!0}},headerCheckboxSelection:!0,headerCheckboxSelectionFilteredOnly:!1,cellRenderer:void 0};cols.unshift(checkboxCol)}}return cols},[baseColumnDefs,findSavedEntryForRow,id]);reactExports.useEffect(()=>{const calculateTableHeight=()=>{const windowHeight=window.innerHeight,windowWidth=window.innerWidth,headerHeight=100,footerHeight=30,bottomSpace=50,minHeight=400,tabletMinWidth=768,tabletMaxWidth=1024;let calculatedHeight;if(windowWidth>=1200)calculatedHeight=windowHeight-headerHeight-footerHeight-bottomSpace;else if(windowWidth>=tabletMinWidth&&windowWidth<=tabletMaxWidth){const tabletAdjustment=windowWidth<900?150:100;calculatedHeight=windowHeight-headerHeight-footerHeight-tabletAdjustment}else calculatedHeight=windowHeight-headerHeight-footerHeight-100;setTableHeight(`${Math.max(calculatedHeight,minHeight)}px`)};calculateTableHeight();window.addEventListener("resize",calculateTableHeight);window.addEventListener("orientationchange",calculateTableHeight);return()=>{window.removeEventListener("resize",calculateTableHeight);window.removeEventListener("orientationchange",calculateTableHeight)}},[]);const handleDrillDown=e=>{var _a2,_b2,_c2;if("2"===id)return;const code=(null==(_a2=null==e?void 0:e.data)?void 0:_a2.Item_Code)??(null==(_b2=null==e?void 0:e.data)?void 0:_b2.item_code)??(null==(_c2=null==e?void 0:e.data)?void 0:_c2["Item Code"])??"";code&&navigate("/dynamictable/2",{state:{itemCode:code}})},heading=selectedDepartment?`Department: ${selectedDepartment}`:selectedBranch?`Branch: ${selectedBranch}`:`ItemCode: ${itemCodeFromState}`,saveSchemeForSelected=data=>{const targets=selectedRows.length?selectedRows:[];targets.forEach(row=>{const existing=findSavedEntryForRow(row),existingData=(null==existing?void 0:existing.data)??{},schemeToSave={...existingData.appliedDisplay?{appliedDisplay:existingData.appliedDisplay}:{},appliedScheme:data};dispatch(saveScheme({row:{...row,itemCode:getItemCodeFromRow(row),branchCode:getBranchCodeFromRow(row)},scheme:schemeToSave}))});setModalOpen(!1);setModalType(null);try{form.reset(defaultFormValues)}catch{}},saveDisplayForSelected=data=>{const targets=selectedRows.length?selectedRows:[];targets.forEach(row=>{const existing=findSavedEntryForRow(row),existingData=(null==existing?void 0:existing.data)??{},schemeToSave={...existingData.appliedScheme?{appliedScheme:existingData.appliedScheme}:{},appliedDisplay:data};dispatch(saveScheme({row:{...row,itemCode:getItemCodeFromRow(row),branchCode:getBranchCodeFromRow(row)},scheme:schemeToSave}))});setModalOpen(!1);setModalType(null);try{form.reset(defaultFormValues)}catch{}},openApplySchemeBulk=()=>{var _a2,_b2;if(!selectedRows.length)return;const preset=1===selectedRows.length?(null==(_b2=null==(_a2=findSavedEntryForRow(selectedRows[0]))?void 0:_a2.data)?void 0:_b2.appliedScheme)??null:null;setModalType("scheme");try{form.reset(defaultFormValues);preset&&form.reset(preset)}catch{}setModalOpen(!0)},openApplyDisplayBulk=()=>{var _a2,_b2;if(!selectedRows.length)return;const preset=1===selectedRows.length?(null==(_b2=null==(_a2=findSavedEntryForRow(selectedRows[0]))?void 0:_a2.data)?void 0:_b2.appliedDisplay)??null:null;setModalType("display");try{form.reset(defaultFormValues);preset&&form.reset(preset)}catch{}setModalOpen(!0)},SchemeModalBody=jsxRuntimeExports.jsx(FormProvider,{...form,children:jsxRuntimeExports.jsxs("form",{onSubmit:form.handleSubmit(saveSchemeForSelected),children:[jsxRuntimeExports.jsxs("div",{className:"mb-3 small text-muted",children:["Applying scheme to ",selectedRows.length," selected row",selectedRows.length>1?"s":"","."]}),jsxRuntimeExports.jsx("div",{className:"row",children:Object.entries(scheme.properties).map(([key,field])=>jsxRuntimeExports.jsx("div",{className:"col-lg-6 col-md-6 mb-3",children:renderFieldWrapper(field,key)},key))})]})}),DisplayModalBody=jsxRuntimeExports.jsx(FormProvider,{...form,children:jsxRuntimeExports.jsxs("form",{onSubmit:form.handleSubmit(saveDisplayForSelected),children:[jsxRuntimeExports.jsxs("div",{className:"mb-3 small text-muted",children:["Applying display to ",selectedRows.length," selected row",selectedRows.length>1?"s":"","."]}),jsxRuntimeExports.jsx("div",{className:"row",children:Object.entries(display.properties).map(([key,field])=>jsxRuntimeExports.jsx("div",{className:"col-lg-12 col-md-12 mb-3",children:renderFieldWrapper(field,key)},key))})]})}),modalFooter="scheme"===modalType?jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>{setModalOpen(!1);setModalType(null);try{form.reset(defaultFormValues)}catch{}},children:"Close"}),jsxRuntimeExports.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>form.handleSubmit(saveSchemeForSelected)(),children:"Save"})]}):"display"===modalType?jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>{setModalOpen(!1);setModalType(null);try{form.reset(defaultFormValues)}catch{}},children:"Close"}),jsxRuntimeExports.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>form.handleSubmit(saveDisplayForSelected)(),children:"Save"})]}):null;return jsxRuntimeExports.jsx(Wrapper,{header:`Phase 3 â€“ ${heading}`,subHeader:"Detail Report",ExportR:1,backButtonName:"Back",children:jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[loading&&jsxRuntimeExports.jsx(CenteredLoader,{}),error&&jsxRuntimeExports.jsx("div",{className:"alert alert-danger",children:error}),!loading&&!error&&jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:["2"===id&&jsxRuntimeExports.jsxs("div",{className:"d-flex gap-2 mb-2 align-items-center",children:[jsxRuntimeExports.jsxs("div",{className:"small text-muted me-2",children:["Selected: ",jsxRuntimeExports.jsx("strong",{children:selectedRows.length})]}),jsxRuntimeExports.jsx("button",{type:"button",className:"btn btn-sm btn-outline-primary",disabled:0===selectedRows.length,onClick:openApplySchemeBulk,children:"Apply Scheme"}),jsxRuntimeExports.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:0===selectedRows.length,onClick:openApplyDisplayBulk,children:"Apply Display"})]}),detailData.length>0&&jsxRuntimeExports.jsx("div",{className:"d-flex flex-wrap gap-2 mb-1 align-items-center",children:Object.entries({"Site Qty":totals.totalSiteQty,"Sale Qty":totals.totalSaleQty,"Sale Value":totals.totalSaleVal,"Sp Value":totals.totalStockValue}).map(([label,value])=>{const cleanValue=Math.floor(Number(value)),displayValue=cleanValue.toLocaleString("en-IN");return jsxRuntimeExports.jsxs("span",{className:"badge bg-light text-dark border px-3 py-2 fw-medium",style:{fontSize:"0.875rem"},title:label,children:[jsxRuntimeExports.jsxs("strong",{children:[label,":"]})," ",displayValue]},label)})}),detailData.length>0?jsxRuntimeExports.jsx(GridTable,{rowData:detailData,columnDefs:displayedColumnDefs,enableEditing:!1,enableSelection:"2"===id,height:tableHeight,onRowClick:handleDrillDown,reportHeader:`Phase_3_${heading}_Summary`,selectedRowsHandler:selectedRowsHandler,onGridReady:handleGridReady}):jsxRuntimeExports.jsx("div",{className:"text-center py-4 text-muted",children:"No data available for the selected view."})]}),jsxRuntimeExports.jsx(SimpleModal,{show:modalOpen,title:"scheme"===modalType?`Apply Scheme to ${selectedRows.length} item${selectedRows.length>1?"s":""}`:"display"===modalType?`Apply Display to ${selectedRows.length} item${selectedRows.length>1?"s":""}`:"",size:"lg",onClose:()=>{setModalOpen(!1);setModalType(null);try{form.reset(defaultFormValues)}catch{}},footer:modalFooter,children:"scheme"===modalType?SchemeModalBody:"display"===modalType?DisplayModalBody:null})]})})};export{Pase3DynamicTable as default};
//# sourceMappingURL=DynamicTable-DG1x85xe.js.map
